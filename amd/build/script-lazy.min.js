define(["jquery"],function(a){icon={backup:{css:"editing_backup",pix:"i/backup"},movedir:{css:"editing_right",pix:"t/right"},move:{css:"editing_move_",pix:"t/move"},edit:{css:"editing_update",pix:"t/edit"},cancel:{css:"editing_cancel",pix:"t/delete"},"delete":{css:"editing_update",pix:"t/delete"},restore:{css:"editing_restore",pix:"i/restore"},"dir-open":{pix:"f/folder-open"},"dir-closed":{pix:"f/folder"}},$block=a(".block_sharing_cart"),$spinner_modal={show:function(){a("#sharing-cart-spinner-modal").show()},hide:function(){a("#sharing-cart-spinner-modal").hide()}},course=new function(){var b=a("body");this.id=b.attr("class").match(/course-(\d+)/)[1],this.is_frontpage=b.hasClass("pagelayout-frontpage")},str=function(a){return M.str.block_sharing_cart[a]||M.str.moodle[a]},show_error=function(a){try{var b=JSON.parse(a.responseText);new M.core.exception({name:str("pluginname")+" - "+str("error"),message:b.message})}catch(c){new M.core.exception({name:str("pluginname")+" - "+str("error"),message:a.responseText})}},get_action_url=function(a,b){var c=M.cfg.wwwroot+"/blocks/sharing_cart/"+a+".php";if(b){var d=[];for(var e in b)d.push(e+"="+encodeURIComponent(b[e]));c+="?"+d.join("&")}return c},verify_layout=function(){var a=$block.find(".menubar .dropdown .dropdown-menu");return a.length},setCookie=function(a,b,c){var d=new Date;d.setTime(d.getTime()+c);var e="expires="+d.toUTCString();document.cookie=a+"="+b+";"+e},getCookieValue=function(a){var b=document.cookie.match("(^|;)\\s*"+a+"\\s*=\\s*([^;]+)");return b?b.pop():""},create_command=function(b,c){var d=a('<img class="iconsmall "/>').attr("alt",str(b)).attr("src",M.util.image_url(c||icon[b].pix));return verify_layout()&&d.addClass("iconcustom"),a('<a href="javascript:void(0)"/>').addClass(icon[b].css).attr("title",str(b)).append(d)},create_special_activity_command=function(b,c){return a('<a href="javascript:void(0)"/>').addClass(icon[b].css).addClass("dropdown-item menu-action cm-edit-action").attr("title",str(b)).append(a('<img class="icon"/>').attr("alt",str(b)).attr("src",M.util.image_url(c||icon[b].pix)))},add_spinner=function(b){var c={pix:"i/loading_small",component:"moodle"};if(b.find(".spinner").length)return b.find(".spinner");var d=a("<img/>").attr("src",M.util.image_url(c.pix,c.component)).addClass("spinner iconsmall").hide();return b.append(d),d},reload_tree=function(){var b=add_spinner($block.find(".commands"));b.show(),a.post(get_action_url("rest"),{action:"render_tree"},function(b){$block.find(".tree").replaceWith(a(b)),init_item_tree()},"text").fail(function(a){show_error(a)}).always(function(a){b.hide()})},backup=function(b,c){var d=a("#module-"+b+" .commands");d.length||(d=a('[data-owner="#module-'+b+'"]')),$spinner_modal.show(),a.post(get_action_url("rest"),{action:"backup",cmid:b,userdata:c,sesskey:M.cfg.sesskey,course:course.id},function(){reload_tree()}).fail(function(a){show_error(a)}).always(function(a){$spinner_modal.hide()})},backup_section=function(b,c){var d=a("span.inplaceeditable[data-itemtype=sectionname][data-itemid="+b+"]"),e=d.closest("li.section.main").attr("aria-label");add_spinner(d);$spinner_modal.show(),a.post(get_action_url("rest"),{action:"backup_section",sectionid:b,sectionname:e,userdata:c,sesskey:M.cfg.sesskey,course:course.id},function(){reload_tree()}).fail(function(a){show_error(a)}).always(function(a){$spinner_modal.hide()})},directories=new function(){function b(){var a=new Date;a.setDate(a.getDate()+30),setCookie(e,f.join(","),a)}function c(a,b){var c=icon[b?"dir-open":"dir-closed"].pix;a.find("> div img").first().attr("src",M.util.image_url(c)),a.find("> ul.list")[b?"show":"hide"]()}function d(d){var e=a(d.target).closest("li.directory"),g=e.attr("id").match(/(\d+)$/)[1],h="none"===e.find("> ul.list").css("display");c(e,h),f[g]=h?1:0,b()}var e="block_sharing_cart-dirs",f=getCookieValue(e).split(",").map(function(a){return parseInt(a)});this.init=function(){var b=0;$block.find("li.directory").each(function(e,g){var h=a(g);h.attr("id","block_sharing_cart-dir-"+b),b>=f.length?f.push(0):f[b]&&c(h,!0),h.find("> div").css("cursor","pointer").click(function(a){d(a)}),b++})},this.reset=function(){f=[],this.init(),b()}},move_targets=new function(){var b=null,c=[];this.hide=function(){if(null!==b){var d=b.closest(".commands");b.remove(),b=null,d.closest("li.activity").css("opacity",1),d.find("a").each(function(){a(this).show()}),a.each(c,function(a,b){b.remove()}),c=[]}},this.show=function(d){function e(b){var c=a(b.target).closest("a").attr("class").match(/move-(\d+)-to-(\d+)/),d=c[1],e=c[2];a.post(get_action_url("rest"),{action:"move",id:d,to:e,sesskey:M.cfg.sesskey},function(){reload_tree()}).fail(function(a){show_error(a)})}function f(b,c){var d=a('<a href="javascript:void(0)"/>').addClass("move-"+b+"-to-"+c).attr("title",str("movehere")).append(a('<img class="move_target"/>').attr("alt",str("movehere")).attr("src",M.util.image_url("dropzone_arrow","block_sharing_cart"))),f=a('<li class="activity"/>').append(a(h[0].cloneNode(!1)).append(d));return d.click(function(a){e(a)}),f}this.hide();var g=$block.find("#block_sharing_cart-item-"+d),h=g.find("div"),i=g.next(),j=g.closest("ul"),k=0;if(i.length&&(k=i.attr("id").match(/item-(\d+)$/)[1]),j.find("> li.activity").each(function(e,g){var h=a(g),i=h.attr("id").match(/item-(\d+)$/)[1];if(i===d){b=create_command("cancel","t/left"),b.click(function(){move_targets.hide()});var j=h.find(".commands");j.find("a").each(function(){a(this).hide()}),j.append(b),h.css("opacity",.5)}else if(i!==k){var l=f(d,i);h.before(l),c.push(l)}},this),i){var l=f(d,0);j.append(l),c.push(l)}}},restore_targets=new function(){function b(b,c){var e="";e=restore_targets.is_directory?get_action_url("restore",{directory:!0,path:b,course:course.id,section:c,sesskey:M.cfg.sesskey}):get_action_url("restore",{directory:!1,id:b,course:course.id,section:c,sesskey:M.cfg.sesskey});var f=a("<a/>").attr("href",e).attr("title",str("copyhere")).append(a('<img class="move_target"/>').attr("alt",str("copyhere")).attr("src",M.util.image_url("dropzone_arrow","block_sharing_cart")));return d.push(f),f}this.is_directory=null;var c=null,d=[];this.hide=function(){null!==c&&(c.remove(),c=null,a.each(d,function(a,b){b.remove()}),d=[])},this.show=function(d){this.hide();var e=a("<span/>");if(this.is_directory)e.html(d).css("display","inline"),e.prepend(a("<img/>").addClass("icon").attr("alt",d).attr("src",M.util.image_url(icon["dir-closed"].pix,null)));else{var f=$block.find("#block_sharing_cart-item-"+d);e=a(f.find("div")[0].cloneNode(!0)).css("display","inline"),e.attr("class",e.attr("class").replace(/mod-indent-\d+/,"")),e.find(".commands").remove()}var g=create_command("cancel");if(g.click(this.hide),c=a('<div class="clipboard"/>'),c.append(str("clipboard")+": ").append(e).append(g),course.is_frontpage){var h=a(".sitetopic"),i=a(".block_site_main_menu");h?h.find("*").before(c):i&&i.find(".content").before(c),i&&i.find(".footer").before(b(d,0)),h&&h.find("ul.section").append(b(d,1))}else{var j=a(".course-content");j.one("*").before(c),j.find(M.course.format.get_section_wrapper(null)).each(function(c,e){var f=a(e),g=f.attr("id").match(/(\d+)$/)[1];f.find("ul.section").append(b(d,g))},this)}}},get_plugin_name=function(){var a=$block.find("h2");return a.length?a.html():(a=$block.find("h3"),a.length?a.html():"")},on_backup=function(b){var c=function(a){var b=a.closest("li.activity");if(b.length)return b.attr("id").match(/(\d+)$/)[1];var c=a.closest(".commands"),d=c.attr("data-owner");return d.length?d.match(/(\d+)$/)[1]:c.find("a.editing_delete").attr("href").match(/delete=(\d+)/)[1]}(a(b.target));!function(b){a.post(get_action_url("rest"),{action:"is_userdata_copyable",cmid:c},function(a){b(a)},"text").fail(function(a){show_error(a)})}(function(a){var b="1"===a;b&&confirm(str("confirm_userdata"))?confirm(str("confirm_backup"))&&backup(c,!0):confirm(str("confirm_backup"))&&backup(c,!1)})},on_movedir=function(b){function c(){var b=i.find('[name="to"]').val();a.post(get_action_url("rest"),{action:"movedir",id:g,to:b,sesskey:M.cfg.sesskey},function(){reload_tree(),directories.reset()}).fail(function(a){show_error(a)})}var d=a(b.target).closest(".commands"),e=d.closest("li.directory"),f=e.length?e.attr("directory-path"):"/",g=a(b.target).closest("li.activity").attr("id").match(/(\d+)$/)[1],h=[];$block.find("li.directory").each(function(){h.push(a(this).attr("directory-path"))});var i=a("<form/>").css("display","inline");if(i.attr("action","javascript:void(0)"),i.submit(c),0===h.length)i.append(a('<input type="text" name="to"/>').val(f));else{h.unshift("/");for(var j=a('<select name="to"/>'),k=0;k<h.length;k++)j.append(a("<option/>").val(h[k]).append(h[k]));j.val(f),j.change(c),i.append(j);var l=create_command("edit");l.click(function(b){var c=a('<input type="text" name="to"/>').val(f);j.remove(),l.replaceWith(c),c.focus()}),i.append(l)}var m=create_command("cancel");m.click(function(){i.remove(),d.find("a").show()}),i.append(m),d.find("a").each(function(){a(this).hide()}),d.append(i)},on_move=function(b){var c=a(b.target).closest("li.activity"),d=c.attr("id").match(/(\d+)$/)[1];move_targets.show(d)},on_delete=function(b){if(confirm(str("confirm_delete"))){var c=a(b.target).closest("li"),d={};c.hasClass("directory")?d={action:"delete_directory",path:c.attr("directory-path"),sesskey:M.cfg.sesskey}:c.hasClass("activity")&&(d={action:"delete",id:c.attr("id").match(/(\d+)$/)[1],sesskey:M.cfg.sesskey});var e=add_spinner(a(b.target).closest(".commands"));e.show(),a.post(get_action_url("rest"),d,function(){reload_tree()}).fail(function(a){show_error(a)}).always(function(){e.hide()}),b.stopPropagation()}},on_restore=function(b){var c=a(b.target).closest("li"),d=null;c.hasClass("directory")?(d=c.attr("directory-path"),restore_targets.is_directory=!0):c.hasClass("activity")&&(d=c.attr("id").match(/(\d+)$/)[1],restore_targets.is_directory=!1),restore_targets.show(d)},on_section_backup=function(b){!function(c){a.post(get_action_url("rest"),{action:"is_userdata_copyable_section",sectionid:b},function(a){c(a)},"text").fail(function(a){show_error(a)})}(function(a){var c="1"===a;c&&confirm(str("confirm_userdata_section"))?confirm(str("confirm_backup_section"))&&backup_section(b,!0):confirm(str("confirm_backup_section"))&&backup_section(b,!1)})},init_bulk_delete=function(b){var c=$block.find(".header-commands .editing_bulkdelete");c.length&&(b?(c.attr("role","menuitem").addClass("dropdown-item menu-action"),c.find("img").addClass("icon"),c.append(a("<span class='menu-action-text'/>").append(c.attr("title"))),$block.find(".menubar .dropdown .dropdown-menu").append(c)):$block.find(".header .commands").append(c))},init_help_icon=function(a){$block.find(".header-commands > .help-icon")},init_block_header=function(){var a=verify_layout();init_bulk_delete(a),init_help_icon(a)},init_item_tree=function(){function b(b,c){var d=a(b),e=d.find(".commands").first();a.each(c,function(a,b){var c=create_command(b);c.click(function(a){"backup"==b?on_backup(a):"movedir"==b?on_movedir(a):"move"==b?on_move(a):"delete"==b?on_delete(a):"restore"==b&&on_restore(a)}),e.append(c)},this)}var c=["movedir","move","delete"];course&&c.push("restore");var d=["delete","restore"];$block.find("li.activity").each(function(a,d){b(d,c)}),$block.find("li.directory").each(function(a,c){b(c,d)}),directories.init()},add_backup_comand=function(b){var c=b.find("ul[role='menu']");if(c.length){var d=c.find("li").first().clone(),e=d.find("a").attr("title",str("backup")).attr("href","javascript:void(0)"),f=d.find("img");f.length?d.find("img").attr("alt",str("backup")).attr("title",str("backup")).attr("src",M.util.image_url(icon.backup.pix)):d.find("i").attr("class","icon fa fa-upload").attr("title",str("backup")).attr("aria-label",str("backup")),d.find("span").html(str("backup")),d.find("a").attr("data-action","backup"),c.append(d)}else{var e=create_command("backup");c=b.find('div[role="menu"]'),c.length?(e=create_special_activity_command("backup"),c.append(e.attr("role","menuitem")),"none"===c.css("display")&&e.append(a("<span class='menu-action-text'/>").append(e.attr("title")))):b.find(".commands").append(e)}e.click(function(a){on_backup(a)})},init_activity_commands=function(){course.is_frontpage?(a(".sitetopic li.activity").each(function(){add_backup_comand(a(this))}),a(".block_site_main_menu .content > ul > li").each(function(){add_backup_comand(a(this))})):a(".course-content li.activity").each(function(){add_backup_comand(a(this))}),a("li.section").each(function(){var b=a(this).find("span.inplaceeditable[data-itemtype='sectionname']").attr("data-itemid"),c=a(this).find("ul[role='menu']").first();if(c.length){var d=c.find("li").first().clone(),e=d.find("img");e.length?e.attr("alt",str("backup")).attr("title",str("backup")).attr("src",M.util.image_url(icon.backup.pix,null)):d.find("i").attr("class","icon fa fa-upload").attr("title",str("backup")).attr("aria-label",str("backup")),d.find("span").html(str("backup")),d.find("a").attr("href","javascript:void(0)"),c.append(d),d.find("a").click(function(){on_section_backup(b)})}else{c=a(this).find("div[role='menu']").first();var f=null;c.length?(f=create_special_activity_command("backup"),c.append(f.attr("role","menuitem")),"none"===c.css("display")&&f.append(a("<span class='menu-action-text'/>").append(f.attr("title")))):(f=create_command("backup"),$activity.find(".commands").append(f)),f.click(function(){on_section_backup(b)})}})};var b=function(){console.log("sharing cart init"),M.str.block_sharing_cart.pluginname=get_plugin_name(),init_block_header(),init_item_tree(),init_activity_commands()},c=function(b){a(b+" li.activity").each(function(){add_backup_comand(a(this))});var c=a(b).find("div[role='menu']").first(),d=null;c.length?(d=create_special_activity_command("backup"),c.append(d.attr("role","menuitem")),"none"===c.css("display")&&d.append(a("<span class='menu-action-text'/>").append(d.attr("title")))):(d=create_command("backup"),$activity.find(".commands").append(d)),d.click(function(){on_section_backup(b)})},d={pix:"i/loading",component:"moodle"},e=a("<img/>").attr("src",M.util.image_url(d.pix,d.component)).addClass("spinner");return a("div#sharing-cart-spinner-modal div.spinner-container").prepend(e),{init:b,reinit_activity_commands:c}});